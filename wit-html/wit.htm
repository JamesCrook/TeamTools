<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>What is That?</title>
    <style type="text/css">

        html *
        {
            font-family: Arial;
        }

    </style>
    <script src="./js/boxes.js"></script>
    <script src="./js/vec2.js"></script>
    <script>

        var Message = null;
        var Clicker = {};
        var Gui = {};
        var Level = 0;
        var Scroller;
        var ClickedBox = -1;
        var HoverBox = -1;
        var LastHover = -2;


        function Corner( Box, index ){
            if( index == 0)
                return Vec2( Box[0], Box[1] );
            if( index == 1)
                return Vec2( Box[2], Box[1] );
            if( index == 2)
                return Vec2( Box[0], Box[3] );
            return Vec2( Box[2], Box[3] );
        }

        function MinMax( Box, direction ){
            var i;
            var result = {};
            for( i=0;i<4;i++){
                var dot = dotProd(Corner( Box, i), direction);
                if( i==0 || result.min > dot )
                    result.min = dot;
                if( i==0 || result.max < dot )
                    result.max = dot;
            }
            return result;
        }

        function SomeArrow( Box1, Box2, direction ){
            var result = { quality:0, p1: Vec2(0,0), p2: Vec2(0,0)};
            var Limits1, Limits2;
            Limits1 = MinMax( Box1, direction );
            Limits2 = MinMax( Box2, direction );
            var min = Math.max(Limits1.min, Limits2.min );
            var max = Math.min(Limits1.max, Limits2.max );
            result.quality = max - min;
            result.direction = Vec2( direction );
            result.value = (max + min) /2;
            return result;
        }

        // Finds the 'best' arrow connecting two boxes.
        function BestArrow( Box1, Box2 ){
            var Arrow = [];
            // Try four distinct directions for the arrow.
            Arrow.push( SomeArrow( Box1, Box2, Vec2( 1, 0 ) ));
            Arrow.push( SomeArrow( Box1, Box2, Vec2( 0, 1 ) ));
            Arrow.push( SomeArrow( Box1, Box2, Vec2( 0.707, 0.707 ) ));
            Arrow.push( SomeArrow( Box1, Box2, Vec2( 0.707, -0.707 ) ));
            var result = Arrow[0];
            var i;
            for(i=1;i<4;i++){
                if( Arrow[i].quality > result.quality )
                    result = Arrow[i];
            }

            return result;
        }


        // @return var
        function FindBox(Source, x, y, Level){

            var i;
            var v;
            var boxes = Source.Boxes[ Level ];
            Source.ThisIx = -1;
            //console.log( "Finding x:"+x+" y:"+y);
            for( i = 0; i < boxes.length; i++ ){
                v = boxes[i];
                if( (v[0] <= x) && (v[1] <= y) && ( v[2] >= x ) &&
                        (v[3] >= y ) ){
                    Source.ThisIx = i;
                    break;
                }
            }
            return Source.ThisIx;
        }

        // Finds subitems from the main list at the chosen level.
        function Extract( List, from, level ){
            var result = [];
            var i;
            for( i=from;i<List.length;i++){
                var lev = List[i][0];
                if( lev < level ){
                    return result;
                }
                if( lev ==level ){
                    var Item = List[i];
                    var Entry =
                        [ Item[1], Item[2], Item[3], Item[4], Item[5],i];
                    result.push( Entry );
                }
            }
            return result;
        }

        function GuiInit(){
            //Gui.Boxes = [ image_boxes, [], [] ];
            Gui.Boxes = [ Extract( AudacityBoxes, 0,1),[],[],[],[],[],[]];
            Gui.Img = document.getElementById("Gui");
            Gui.Canvas = document.getElementById("GuiCanvas");
            Gui.Ctx = Gui.Canvas.getContext("2d");
            Gui.DoesFade = true;
            Gui.Rect = [0,0,865,583];
            Gui.BackDraw = function() { Gui.Ctx.drawImage(Gui.Img, 0, 0);}
            Gui.FrontDraw = function( x,y,w,h ){
                Gui.Ctx.drawImage(Gui.Img, x, y, w, h, x, y, w, h);
            }
        }

        function ClickerInit(){
            //Clicker.Boxes = [ clicker_boxes, [],[]];
            Clicker.Boxes = [ Extract( AudacityBoxes, 0,1),[],[],[],[],[],[]];
            Clicker.Img = document.getElementById("Gui");
            Clicker.Canvas = document.getElementById("GuiCanvas");
            Clicker.Ctx = Gui.Canvas.getContext("2d");
            Clicker.DoesFade = false;
            Clicker.Rect = [0,583,1225,740];
            Clicker.BackDraw = function(){
                var G = Clicker;
                var YY = Gui.Img.height;
                G.Ctx.fillStyle = 'white';
                G.Ctx.fillRect(0, YY, G.Canvas.width, G.Canvas.height-YY);
            };
            Clicker.FrontDraw = RedrawClicker;
        }

        function EmptyLevel(){
            ClickedBox = HoverBox;
            HoverBox = -1;
            LastHover = -2;

            Gui.Boxes[ Level+1 ] = [];
            Clicker.Boxes[ Level+1 ] = [];
            Level += 1;
            return true;

        }

        function ChangeLevel( delta ){
            if( Level + delta > 4 ){
                return false;
            }
            if( (Level + delta) < 0 ){
                return false;
            }
            if( HoverBox < 0 )
                return false;
            if( delta == 1){
                var index = Gui.Boxes[ Level ][HoverBox][5]+1;
                var inside = Extract( AudacityBoxes,index, Level+2 );
                if( inside.length < 1 )
                    return false;

                console.log( "Descending: ", inside );
                ClickedBox = HoverBox;
                HoverBox = -1;
                LastHover = -2;

                Gui.Boxes[ Level+1 ] = inside;
                // Rather than deep copy the extracted items,
                // we just extract them a second time.
                inside = Extract( AudacityBoxes,index, Level+2 );
                Clicker.Boxes[ Level+1 ] = inside;
                Level += 1;
                return true;
            }
            return false;
        }

        // Draws one text item
        function DrawClicky( G, Where, Box ){
            var str = Box[4];
            var w = G.Ctx.measureText(str).width + 30;
            var XX = Where[0];
            var YY = Where[1];

            G.Ctx.font = "18px Arial";
            G.Ctx.fillStyle = 'blue';
            G.Ctx.fillText(str, XX + 15, YY + 22);
            Box[0] = XX;
            Box[1] = YY;
            XX += w;
            Box[2] = XX;
            Box[3] = YY + Where[3];

            Where[0]=XX;
            Where[1]=YY;

        }

        function RedrawClicker(){
            var G = Clicker;
            var i;
            var YY = Gui.Img.height+4;
            var LL = Level;
            if( LL > 0 )
                LL-=1;

            // Clicker at bottom of image...
            var Channels = [[ 40, YY, 1225-40, 30 ],[ 40, YY+30, 1225-40, 30 ]];
            for( i = 0; i < G.Boxes[LL].length; i++ ){
                DrawClicky( G, Channels[i%2], G.Boxes[LL][i] )
            }
            if( Level < 1)
                return;

            // Clicker superimposed on image...
            LL=Level;
            var BoxRow = Gui.Boxes[LL-1][ClickedBox];
            var Start = Math.max( 2, BoxRow[0] - 100);
            var Spread = Math.min( Math.max( BoxRow[1]-70, 10 ), 30);

            Channels =[];

            Channels.push( [Start, BoxRow[1]-40-Spread, 0, 30] );
            if( (Gui.Rect[2]-BoxRow[3]-320 ) > 80 )
                Channels.push( [Start, BoxRow[3]+10+Spread, 0, 30] );

            for( i = 0; i < G.Boxes[LL].length; i++ ){
                DrawClicky( G, Channels[i%Channels.length], G.Boxes[LL][i] )
            }
        }

        window.onload = function(){
            Message = document.getElementById("message");
            Scroller = document.getElementById("scroller");
            GuiInit();
            ClickerInit();
            MayRefresh();
        }

        function DrawFadedBack( Gui ){
            Gui.BackDraw();
            Gui.Ctx.globalAlpha = 0.85;
            Gui.Ctx.fillStyle = 'white';
            var R = Gui.Rect;
            Gui.Ctx.fillRect(R[0],R[1], R[2]-R[0], R[3]-R[1]);
            Gui.Ctx.globalAlpha = 1.0;
        }

        function DrawBlueFade( Gui, x, y, w, h ){
            Gui.Ctx.globalAlpha = 0.1;
            Gui.Ctx.fillStyle = 'blue';
            Gui.Ctx.fillRect(x, y, w, h);
            Gui.Ctx.globalAlpha = 1.0;
        }

        function DrawBlueSurround( Gui, x, y, w, h ){

            Gui.Ctx.strokeStyle = 'blue';
            Gui.Ctx.lineWidth = 4;
            Gui.Ctx.beginPath();
            Gui.Ctx.rect(x, y, w, h);
            Gui.Ctx.stroke();
        }

        function DrawRedSurround( Gui, x, y, w, h ){
            Gui.Ctx.strokeStyle = 'blue';
            Gui.Ctx.lineWidth = 4;
            Gui.Ctx.beginPath();
            Gui.Ctx.rect(x, y, w, h);
            Gui.Ctx.stroke();
        }

        function RefreshImage(Gui){
            var backfade = (Level > 0) && Gui.DoesFade;

            if( backfade ){
                DrawFadedBack( Gui );
                var box = Gui.Boxes[Level - 1][ClickedBox];
                var x = box[0];
                var y = box[1];
                var w = box[2] - box[0];
                var h = box[3] - box[1];
                Gui.FrontDraw( x, y, w, h );
                DrawRedSurround(Gui, x, y, w, h);
            } else {

                Gui.BackDraw();
                Gui.FrontDraw();
                // Connect parent box...
                ConnectBoxes(Level - 1, ClickedBox, 0);
                if( Level > 0 ){
                    var i;
                    for( i=0;i<Gui.Boxes[Level].length; i++){
                        ConnectBoxes( Level, i, 2 );
                    }
                }
            }

            // The highlighted box...
            if( HoverBox < 0 )
                return;

            var box = Gui.Boxes[ Level][HoverBox];
            var x = box[0];
            var y = box[1];
            var w = box[2] - box[0];
            var h = box[3] - box[1];
            DrawBlueFade( Gui, x,y,w,h);
            DrawBlueSurround( Gui, x,y,w,h );

        }

        function Arrow( v1,v2, style ){
            var Head = 'black';
            if( style < 0 ){
                Head = 'grey';
                style = -style;
            }
            var headLength = 27-style*5;
            var headWidth = 5-style;

            var d1 = v2.sub(v1);
            var d2 = d1.normal();
            var d3 = d1.normalPerp();
            var u1 = v1;
            var u2 = v1.add( d1).sub( d2.times( headLength ));
            var u3;
            Gui.Ctx.strokeStyle = 'grey';
            Gui.Ctx.lineWidth = 4-style;
            Gui.Ctx.beginPath();
            Gui.Ctx.moveTo(u1.x(), u1.y());
            Gui.Ctx.lineTo(u2.x(), u2.y());
            Gui.Ctx.stroke();

            Gui.Ctx.fillStyle = Head;
            u1 = u2.add( d3.times(headWidth) );
            u3 = u2.add( d2.times( headLength - headWidth) );
            u2 = u2.sub( d3.times(headWidth) );
            Gui.Ctx.beginPath();
            Gui.Ctx.moveTo(u1.x(), u1.y());
            Gui.Ctx.lineTo(u2.x(), u2.y());
            Gui.Ctx.lineTo(u3.x(), u3.y());
            Gui.Ctx.fill();
            //console.log( v2.x );
            //console.log( "from "+v1.asText()+" to "+v2.asText());

        }

        function ScrollTo( Target ){
            var i;
            for(i=0;i<urls.length;i++){
                if( urls[i][0] == Target){
                    var src = urls[i][1];
                    Scroller.src = "./scroller-contents/" + src;
                    return;
                }
            }
        }

        function ConnectBoxes(level, boxIx, style){
            if( level < 0 )
                return;
            var b1 = Gui.Boxes[ level][boxIx ];
            var b2 = Clicker.Boxes[ level][boxIx ];

            var x1 = (b1[0]+b1[2])/2;
            var y1 = b1[3];
            var x2 = (b2[0]+b2[2])/2;
            var y2 = b2[1];
            if( y1 > y2 ){
                y2 = b2[3];
                y1 = b1[1];
            }
            var xmin;
            var xmax;
            var h;
            var bImproved = false;
            // Possibly vertical arrow.
            if( !bImproved ){
                xmin = Math.max( b1[0]+10,b2[0] );
                xmax = Math.min( b1[2]-10,b2[2] );
                if( xmin < xmax ){
                    x1 = (xmin + xmax) / 2;
                    x2 = x1;
                    bImproved = true;
                }
            }
            if( !bImproved ){
                h = y2-y1;
                h*=1.5;
                xmin = Math.max( b1[0]+10,b2[0]-h );
                xmax = Math.min( b1[2]-10,b2[2]-h );
                if( xmin < xmax ){
                    x1 = (xmin + xmax) / 2;
                    x2 = x1+h;
                    bImproved = true;
                }
            }
            if( !bImproved ){
                h = y1-y2;
                h*=1.5;
                xmin = Math.max( b1[0]+10,b2[0]-h );
                xmax = Math.min( b1[2]-10,b2[2]-h );
                if( xmin < xmax ){
                    x1 = (xmin + xmax) / 2;
                    x2 = x1+h;
                    bImproved = true;
                }
            }
            if( !bImproved ){
                style = -style;
            }

            Arrow( Vec2(x2,y2), Vec2( x1,y1), style  );
        }

        function MayRefresh(){
            if( LastHover != HoverBox ){
                RefreshImage(Gui);
                RefreshImage(Clicker);
                LastHover = HoverBox;
                if( HoverBox >= 0 ){
                    var B = Gui.Boxes[Level][HoverBox];
                    Message.innerHTML = B[4] + "<br>:"+B[0]+":"+B[1]+":"+B[2]+":"+B[3];
                }
                else
                    Message.innerHTML = 'None '+Level;
            }
        }

        function GetHoverBox( event ){
            var XX = event.offsetX;
            var YY = event.offsetY;
            var box;
            box = FindBox(Gui, XX, YY, Level);
            return box;
        }

        function GetHoverAnnoTextBox( event ){
            var XX = event.offsetX;
            var YY = event.offsetY;
            var box;
            box = FindBox(Clicker, XX, YY, Level);
            return box;
        }

        function GetHoverLowTextBox( event ){
            var XX = event.offsetX;
            var YY = event.offsetY;
            var box =-1;
            if( Level < 1 )
                return box;
            box = FindBox(Clicker, XX, YY, Level-1);
            return box;
        }

        function UpdateSelection(){
            // Try bottom rows.
            HoverBox = GetHoverLowTextBox( event );
            if( HoverBox >= 0 ){
                Level -=1;
                LastHover = -2;
                ClickedBox = HoverBox;
                if( !ChangeLevel(1) ){
                    EmptyLevel();
                }
                return;
            }
            // Try items in on-screen annotation
            HoverBox = GetHoverAnnoTextBox( event );
            if( HoverBox >= 0 ){
                ChangeLevel(1)
                //LastHover = -2;
                //MayRefresh();
                return;
            }
            // Try items on screen
            HoverBox = GetHoverBox( event );
            if( HoverBox >= 0 ){
                while ( ChangeLevel(1) ){
                    HoverBox = GetHoverBox( event );
                    LastHover = -2;
                    MayRefresh();
                }
                if( Level < 1 )
                    EmptyLevel();
                return;
            }

            // Nothing found.  Reset to 0.
            Level = 0;
            ClickedBox = -1;
            HoverBox = -1;//GetHoverBox( event );
            LastHover = -2;

            // Try items on screen again.
            HoverBox = GetHoverBox( event );
            if( HoverBox >= 0 ){
                while ( ChangeLevel(1) ){
                    HoverBox = GetHoverBox( event );
                    LastHover = -2;
                    MayRefresh();
                }
                if( Level < 1 )
                    EmptyLevel();
                return;
            }


        }

        function ImageClick(event, isclick){
            var Target;
            if( isclick){
                UpdateSelection();
                if( HoverBox >= 0 ){
                    Target = Gui.Boxes[ Level][HoverBox][4];
                    ScrollTo( Target );
                } else if( ClickedBox >= 0 ){
                    Target = Gui.Boxes[ Level-1][ClickedBox][4];
                    ScrollTo( Target );
                }
            }  else {
                HoverBox = GetHoverBox( event );
                if( HoverBox < 0 )
                    HoverBox = GetHoverAnnoTextBox( event );
            }
            MayRefresh();
        }
    </script>
</head>
<body>

<div style="width:100%; text-align:center">
    <h1>The Audacity "What is That?" Help Page</h1>
    <h2>Click on the diagram to find out more</h2>
    <div style="width:1225px;position:relative;display:inline-block;margin-left:auto;margin-right:auto;">
        <canvas id="GuiCanvas"
                style="position:absolute;left:0px;top:0px;"
                height="740px"
                width="1225px"
                OnClick="ImageClick(event,true);"
                OnMouseMove="ImageClick(event,false)"
                alt="Clickable Canvas"></canvas>
        <iframe id="scroller" style="position:absolute;left:865px;top:0px;"
                height="583px"
                width="350px"
                src="./scroller-contents/top_menu.html"
                seamless></iframe>
    </div>
</div>
<div id="message">some message</div>
<img id="Gui" src="./images/blank-links.png"
     style="display:none;"
     alt="Audacity">
</body>
</html>