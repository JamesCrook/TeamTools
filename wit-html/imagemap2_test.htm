<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Automation Images</title>
    <style type="text/css">
        h1 { font-size: 2em; }
        h2 { font-size: 1.5em; }
        h3 { font-size: 1.17em; }
        h4 { font-size: 1.12em; }
        h5 { font-size: .83em; }
        h6 { font-size: .67em; }

        html *
        {
            font-family: Arial;
        }

        #logoback {
            transition: all 0.15s;
            background-color: #edebfc;
            border: 2px solid;
            border-color: #edebfc;
            position:absolute;
            top:1.25em;
            left:0.9375em;
            width:5.75em;
            height:5.75em;
            color:black;
            box-sizing:border-box;
            line-height:5.75em;
            border-radius:2.875em;
            box-shadow:0px 0px 1.25em 1px #000080;"

        }
        #logoback:hover {
            /*background-color: #c7cfff;*/
            border-color: #848ff8;
        }
        #logo
        {
            position:relative;
            top:0.5em;
            left:0.5625em;
            transition: all 0.1s;
            width:4.375em;
            height:4.375em;

        }
        #logo:hover
        {
            /*top:6px;*/
            /*transform: rotate(10deg);*/
        }
        #logo:hover:active {
            width:5em;
            height:5em;
            left:0.25em;
            top:0.0625em;
        }

        pre {
            background-color: #1d2134;
            color: yellow;
        }
        div.bt {

            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -khtml-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;

            display:inline-block;
            color:black;
            font-size:13px;
            border: 1px solid;
            padding:2px 15px 2px 15px;
            border-color: #8696b2;
            background-color: #c5d4fc;
            box-shadow: inset 0 -5px 5px 0 #a6c1e7;
        }
        div.bt:hover {
            cursor: pointer;
            /*box-shadow: inset 0 -5px 15px 0 #7c94b7;*/
            background-color: #a9bdff;
            border-color: #2130ba;
        }
        div.bt:hover:active {
            background-color: #a5c3ee;
            box-shadow: inset 0 2px 5px 0 #7c94b7;
        }
        div.linky {
            transition: all 0.15s;
            display:none;
            background-color: #c5d4fc;
            border: 2px solid;
            border-color: #c5d4fc;
            /*border-color: #8696b2;*/
            padding:0px 1.25em 0px 1.25em;
            color:black;
            height:2.25em;
            line-height:2.25em;
            box-sizing:border-box;
            border-radius:1.25em;
            margin:0 auto;
            box-shadow:0 0 20px 1px #000080;
            cursor: pointer;

        }
        div.linky:hover {
           /* background-color: #a5c3ee;*/
            border-color: #848ff8;

        }

        div.pos-resetter {
            width:100%;
            display:inline-block;
            text-align:center;
            position:absolute;
            margin:0 auto;
        }

        div.detaildiv
        {
            padding: 20px;
            box-sizing: border-box; /* so the div is exactly the requested size.*/
            border: 1px solid #000;
            border-radius: 5px;
            -moz-border-radius: 5px;
            text-align:left;
            margin:0px;
        }

        div a
        {
            color: #f5b40b;
        }

        div.detaildiv a
        {
            color: #f5b40b;
        }

        img.centred {
            position: absolute;
            top: -9999px;
            left: -9999px;
            bottom: -9999px;
            right: -9999px;
            margin:auto;
        }
    </style>
    <script>
        console.log( "Protocol is "+window.location.protocol);
        if (window.location.protocol == "http:"){
            console.log("Http: detected");
            if( window.location.href.indexOf("localhost") < 0 )
                window.location.href = "https:" + window.location.href.slice(5);
        }

        var Annotator = {};

        var A=Annotator;
        A.Spec ={}; // the unparsed spec from wiki arrives here.
        A.Porthole = {};
        A.Porthole.width = 1024;
        A.Porthole.height = 567;
        A.Porthole.margin = 5;
        A.Image = {};
        A.Image.imageSrc = './images/AudacityAu19.jpg';
        A.Hotspots = {};
        A.Hotspots.imageSrc = './images/AudacityAu19HS.png';
        A.Focus = {};
        A.Focus.radius = 150;
        A.Detail = {};
        A.Detail.width = 400;
        A.Detail.height = 300;

        A.AddHot = function( index ){
            var actions = new Object();
            A.Hotspots.Colours[ index ] = actions;
            A.Hotspots.Current = actions;
            actions.Zone = A.Hotspots.count++;
        };

        var Nozone={};
        Nozone.Zone = 0;

        function resetHotspots(){
            var A = Annotator;
            A.Hotspots.Colours = [];
            A.Hotspots.count = 0;
            // Bogus entry to catch bad tips.
            A.AddHot( "(1,0,0,0)" );

            A.Buttons = {};
            A.Buttons.Names = [];
            A.Buttons.chosen = -1;
        }

        resetHotspots();


        A.AddButton = function( text ){
            A.Buttons.Names.push( text );
            A.AddHot( "(0,1,"+ A.Buttons.Names.length + ",255)");
        };

        A.AddInfo = function( ){
            A.AddHot( "(0,0,1,255)");
        };

        A.AddDetail = function( text ){
            A.Hotspots.Current.Tip = text;
        };

        A.AddHover = function( text ){
            A.Hotspots.Current.Hover = text;
        };

        var Status = {};
        Status.OldHit = -1;
        Status.imagesToCome = 2;

        var Message;
        var Message2;

        function recomputePorthole(){
            var extra = A.Buttons.Names.length ? 25 : 0;
            A.Porthole.width = A.Backing.img.width;
            A.Porthole.height = A.Backing.img.height+extra;
        }


        function resizeDivs(){
            var A = Annotator;
            A.MainDiv.style.width = A.Porthole.width+'px';
            A.MainDiv.style.height = A.Porthole.height+'px';
            A.BackingCanvas.width = A.Porthole.width;
            A.BackingCanvas.height = A.Porthole.height;
            A.FocusCanvas.width = A.Porthole.width;
            A.FocusCanvas.height = A.Porthole.height;
            A.DetailDiv.style.width = A.Detail.width+'px';
            A.DetailDiv.style.height = A.Detail.height+'px';
        }

        function anotherImageReady(){
            Status.imagesToCome--;
            if( Status.imagesToCome > 0 )
                return;
            Status.isAppReady = true;
        }

        function onBackingImage(){
            recomputePorthole();
            resizeDivs();

            drawBacking();
            anotherImageReady();
        }


        function onHotspotImage(){
            var A = Annotator;
            A.Hotspots.canvas.width = A.Hotspots.img.width;
            A.Hotspots.canvas.height = A.Hotspots.img.height;
            A.Hotspots.ctx = A.Hotspots.canvas.getContext('2d');
            drawHotspots();
            anotherImageReady();
        }

        function onFailedImage(){
            alert("Image failed to load");
        }

        function detailPosFromCursorPos( x,y ){
            var A = Annotator;
            var pt = {};
            // get position as somewhere in range -1..+1
            var vx = 2.0*x/A.Porthole.width-1;
            var vy = 2.0*y/A.Porthole.height -1;

            // Detail panel will be hard right or hard left.
            vx = (vx>0) ? -1:1;

            // Message2.innerHTML = "Vec: ("+vx+","+vy+")";
            pt.x = (vx+1) * (A.Porthole.width - A.Detail.width) * 0.5;
            pt.y = (vy+1) * (A.Porthole.height - A.Detail.height) * 0.5;

            return pt;
        }

        function drawHotspots(){
            var extra = A.Buttons.Names.length ? 25 : 0;
            var img = A.Hotspots.img;
            A.Hotspots.ctx.drawImage(img, 0, extra, img.width, img.height);
            drawButtons();
        }

        function drawBacking(){
            var A = Annotator;
            var img = A.Backing.img;
            var extra = A.Buttons.Names.length ? 25 : 0;

            A.BackingCanvas.ctx.drawImage(img, 0, extra, img.width, img.height);
            drawButtons();
        }

        function drawButtons(){
            var A = Annotator;
            var xw = 60;
            var yh = 25;
            var gap = 9;
            var n = A.Buttons.Names.length;
            var m = 1;
            // grid of n by m buttons, with gaps between them.
            var x = (A.Porthole.width  - n *(xw+gap) + gap) *0.5;
            var y = 0;//(A.Porthole.height - m *(yh+gap) + gap) *0.5;
            var ctx = A.BackingCanvas.ctx;
            var ctx2 = A.Hotspots.ctx;
            ctx.lineWidth = 3;
            ctx.font="16px Arial";
            ctx.strokeStyle = "rgba( 55, 55,155,1.0)";
            ctx2.lineWidth = 0;

            var i;
            for( i=0;i<n;i++){
                var xx = x + i * (xw + gap);
                var yy = y + 1;
                ctx.beginPath();
                if( (i+1)== A.Buttons.chosen )
                    ctx.fillStyle = "rgba(255,255,255,1.0)";
                else
                    ctx.fillStyle = "rgba(205,205,205,1.0)";

                ctx.rect(xx, yy, xw, yh);
                ctx.fill();
                ctx.stroke();
                ctx.fillStyle = "rgba(0,0,0,1.0)";
                ctx.fillText(A.Buttons.Names[i], xx+11, yy+18 );
                ctx2.beginPath();
                ctx2.fillStyle = "rgba(0,1,"+(i+1)+",1.0)";
                ctx2.rect( x + i*(xw+gap), y+ 0*(yh+gap), xw, yh);
                ctx2.fill();
            }
            drawInfoButton();
        }

        function drawInfoButton(){
            var A = Annotator;
            var xw = 25;
            var yh = 25;
            var x = 5;
            var y = 5;
            var ctx = A.BackingCanvas.ctx;
            var ctx2 = A.Hotspots.ctx;
            ctx.lineWidth = 3;
            ctx.font="20px Times New Roman";
            ctx.strokeStyle = "rgba( 55, 55,155,1.0)";
            ctx2.lineWidth = 0;

            ctx.beginPath();
            ctx.fillStyle = "rgba(255,255,255,1.0)";

            ctx.arc(x+xw/2, y+yh/2, xw/2, 0, Math.PI * 2.0, true);
            ctx.fill();
            ctx.stroke();
            ctx.fillStyle = "rgba(0,0,0,1.0)";
            ctx.fillText( "i", x+9, y+19 );
            ctx2.beginPath();
            ctx2.fillStyle = "rgba(0,0,1,1.0)";
            ctx2.rect(x, y, xw, yh);
            ctx2.fill();
        }



        function drawFocusSpot( x, y ){
            var A = Annotator;
            var ctx= A.FocusCanvas.ctx;
            var extra = A.Buttons.Names.length ? 25 : 0;


            ctx.globalCompositeOperation = 'source-over';
            ctx.clearRect(0,0, A.Porthole.width, A.Porthole.height);
            ctx.fillStyle = "rgba( 255,255,255,0.5)";
            var m = A.Porthole.margin;
            ctx.fillRect(m,m+extra, A.Porthole.width-2*m, A.Porthole.height-2*m-extra);

            ctx.fillStyle = "rgba(0,255,255,1.0)";
            ctx.globalCompositeOperation = 'destination-out';
            if( y<extra )
                return;


            ctx.beginPath();
            ctx.arc( x, y, A.Focus.radius, 0, Math.PI * 2.0, true );
            ctx.closePath();
            ctx.fill();
        }

        function removeAdornments(e){
            if( !Status.isAppReady )
                return;
            if( e.shiftKey )
               return;
            var A = Annotator;
            var ctx= A.FocusCanvas.ctx;
            ctx.globalCompositeOperation = 'source-over';
            ctx.clearRect(0,0, A.Porthole.width, A.Porthole.height);
            A.DetailDiv.style.display = "none";
            Status.OldHit = -1;
        }

        function actionsFromCursorPos( x, y ){
            var A=Annotator;
            if( !A.Hotspots.ctx )
                return -1;
            var pixel = A.Hotspots.ctx.getImageData(x,y,1,1).data;
            var result= "("+pixel[0]+","+pixel[1]+","+pixel[2]+","+pixel[3]+")";
            var actions = A.Hotspots.Colours[result] || Nozone;
            Message2.innerHTML = "Colour &amp; Zone: rgba" + result + ", Zone "+actions.Zone;
            return actions;
        }

        function setNewImage( url ){
            var A=Annotator;
            // rather than adding 1, we set the count to 1.
            // That's because if we ask too quickly, only the
            // most recent request will be honoured.
            Status.imagesToCome=1;
            A.Backing.img.src = url;
        }

        function mousemoveOnMap(e){
            if( !Status.isAppReady )
                return;

            var A=Annotator;
            if( e.shiftKey )
                    return;
                var x = e.clientX -A.MainDiv.offsetLeft;
            var y = e.clientY -A.MainDiv.offsetTop;
            var coordinates = "Coordinates: (" + x + "," + y + ")";

            var pt = detailPosFromCursorPos( x, y);

            drawFocusSpot( x,y );
            var actions = actionsFromCursorPos(x,y);
            Message.innerHTML = coordinates;
            A.DetailDiv.style.left = pt.x+"px";
            A.DetailDiv.style.top = pt.y+"px";
            if( Status.OldHit != actions.Zone ){
                Status.OldHit = actions.Zone;

                // Update the detail div
                A.DetailDiv.style.display = ( actions.Tip )?"block":"none";
                if( actions.Tip){
                    A.DetailDiv.innerHTML = actions.Tip;
                }
                // Do any additional hover action
                if( actions.Hover ){
                    A.Buttons.chosen = actions.Zone;
                    setNewImage(actions.Hover);
                }
            }
        }

        function createDomElements(){
            var A=Annotator;
            var contentHere= document.getElementById("content_here");

            // Used for debugging messages
            Message= document.getElementById("message");
            Message2= document.getElementById("message2");

            // MainDiv contains all the other divs
            A.MainDiv = document.createElement( "div");
            // Backing canvas has the image drawn into it
            A.BackingCanvas = document.createElement( "canvas" );
            // Focus canvas has the white-out with focus circle
            A.FocusCanvas = document.createElement( "canvas" );
            // Detail div floats above the white-out
            A.DetailDiv = document.createElement( "div" );

            contentHere.appendChild( A.MainDiv );
            A.MainDiv.appendChild( A.BackingCanvas );
            A.MainDiv.appendChild( A.FocusCanvas );
            A.MainDiv.appendChild( A.DetailDiv );

            A.MainDiv.style.position="relative";
            A.MainDiv.style.display="inline-block";
            A.MainDiv.style.marginLeft="auto";
            A.MainDiv.style.marginRight="auto";
            A.MainDiv.style.overflow="hidden";

            A.BackingCanvas.style.position = "absolute";
            A.BackingCanvas.style.left = "0px";
            A.BackingCanvas.style.top = "0px";
            A.BackingCanvas.ctx = A.BackingCanvas.getContext('2d');

            A.FocusCanvas.onmousemove=mousemoveOnMap;
            A.FocusCanvas.onmouseout=removeAdornments;

            A.FocusCanvas.style.position = "absolute";
            A.FocusCanvas.style.left = "0px";
            A.FocusCanvas.style.top = "0px";
            A.FocusCanvas.ctx = A.FocusCanvas.getContext('2d');

            A.DetailDiv.innerHTML="Some Text";
            A.DetailDiv.style.backgroundColor = "rgba(0,0,0,0.6)";
            A.DetailDiv.style.position = "absolute";
            A.DetailDiv.style.left = "0px";
            A.DetailDiv.style.top = "0px";

            A.DetailDiv.style.display = "none";
            A.DetailDiv.className = "detaildiv";
            resizeDivs();

        }

        function updateImages(){
            Status.imagesToCome=2;
            A.Hotspots.img.src = A.Hotspots.imageSrc;
            A.Backing.img.src = A.Image.imageSrc;
        }

        function requestImages(){
            var A=Annotator;
            //Status.isAppReady = true;
            A.Hotspots.img = document.createElement('img');
            A.Hotspots.canvas = document.createElement('canvas');
            A.Hotspots.img.onload = onHotspotImage;
            A.Hotspots.img.onerror = onFailedImage;

            A.Backing = {};
            A.Backing.img = document.createElement( "img");
            A.Backing.img.onload = onBackingImage;
            A.Backing.img.onerror = onFailedImage;
            A.Backing.img.className="centred";
            updateImages();
        }

        function setATitle( caption ){
            var atitle= document.getElementById("atitle");
            atitle.innerHTML = "<em>"+caption+"</em>";
        }

        function fieldValue( field, line ){

            var value = line.split( field+"=" )[1] || "";
            value = value.split( ";")[0];
            value = value.split( "</pre>")[0];
            return value;

        }

        function loadNewDetails( data ){
            var A=Annotator;
            var lines = data.split("<pre>");
            setATitle("Caption was missing");
            for(i=0;i<lines.length;i++)
            {
                var item=lines[i];
                var detail = item.split("TIP=</pre>")[1];
                var file  = item.split( "[[File:")[1] || "";
                file = file.split( "]]")[0] || "";
                file = "./images/"+file;

                if( item.startsWith("ZONE:RGBA=(")){
                    var index = fieldValue( "RGBA", item );
                    index=index.split(" ").join("");
                    console.log("color:"+index);

                    A.AddHot( index );
                }
                if( item.startsWith("ZONE:LABEL=")){
                    var label = fieldValue( "LABEL",item );
                    console.log("label:"+label);
                    A.AddButton( label );
                    if( !detail )
                        detail =" ";
                }
                if( item.startsWith("HOVER LOAD IMAGE")){
                    console.log("hover-load:"+file);
                    A.Hotspots.Current.Hover = file;
                }
                if( item.startsWith("IMAGE")){
                    console.log("image:"+file);
                    A.Image.imageSrc = file;
                }
                if( item.startsWith("HOTSPOTS")){
                    console.log("hotspots:"+file);
                    A.Hotspots.imageSrc = file;
                }
                if( item.startsWith("CREDITS")){
                    var caption = fieldValue( "CAPTION",item );
                    console.log("caption:"+caption);
                    setATitle( caption );
                    A.AddInfo();
                }
                if( detail ){
                    console.log(" <<<" + detail + ">>>");
                    A.AddDetail(detail);
                }
            }
            updateImages();
        }

        function handleNewData( data ){
            var spec = document.getElementById("spec");
            // for debugging...
            //spec.innerHTML = data.split("<pre>START</pre>")[1];
            resetHotspots();
            loadNewDetails( data );
        }

        /**
         * Loads one source file into an item in an array.
         * @param data
         * @param action
         * @param url
         */
        function fileActionLoader(data, action, url ){
            var txtFile = new XMLHttpRequest();
            // CDNs and Varnish should give us the very latest.
            txtFile.onreadystatechange = function(){
                if( this.readyState === 4 && this.status == 200 ){
                    // data.push({ action: action, value: this.responseText});
                    handleNewData( this.responseText);
                }
            };

            txtFile.open("GET", url , true);
            //txtFile.setRequestHeader( "Cache-Control", "s-maxage=0" );
            txtFile.send();
        }


        function requestSpec( source ){
            var A=Annotator;
            A.SpecName = source;
            var date = new Date();
            var nMillis = date.getTime();


            var str = window.location.href;
            var bLocal = str.indexOf( 'localhost' ) != -1;
            bLocal = bLocal || source.startsWith( "Local" );

            if( bLocal ){
                fileActionLoader("","","./raw/raw_spec_"+source+".txt");
            } else {
                // action=raw to get unprocessed file from wiki.
                // time=nMillis to avoid issues with cached content.
                fileActionLoader( "","","https://wiki.audacityteam.org/wiki/Toolbox/"+source+"?action=raw&time=" +
                        nMillis);
            }



        }

        function loadDiagram( source ){
            var spec = document.getElementById("spec");
            spec.innerHTML = "";
            requestSpec( source );
        }

        window.onload = function(){
            createDomElements();
            requestImages();
            loadDiagram("The_AU19_Crowd");
            //requestSpec();
        }

    </script>
</head>
<body style="color:white;background-image:url(images/header-home-bg.jpg);margin:0px;background-attachment:fixed;">
<div style="width:100%; text-align:center;background:#1d2134;height:5em;margin: 0px;">
    <h1 style="margin:0px;padding-top:0.65em;padding-bottom:0.9em;"><em>Audacity Toolbox</em>: Focus-Detail ImageMap Test</h1>
    <div style="width:100%; text-align:center;background:#303b70;position:relative;height:1.8em;top:-0.6em;box-shadow: inset 0 0px 4px 0px #000080, 0 -2px 7px -2px #618ef4;"></div>
</div>
<div style="width:100%;position:relative;top:-0.50em;left:0;display:inline-block;margin:0 auto;height:3em;">
    <div class='pos-resetter'>
        <h2 id="click-tip" style="color:#bfbfbf;display:block;position:relative;top:-0.55em;transition:opacity 4s;opacity:1;"><em>Version from 17-Nov-2019</em></h2>
    </div>
    <div class='pos-resetter'>
        <div style="display:inline-block;">
            <div class='linky' id="manual-url-holder">
                Manual's URL, here</div> &nbsp;
            <div class='linky' id="wit-url-holder">
                WIT's URL, here</div> &nbsp;
            <div class='linky' id="doxy-url-holder">
                Doxygen's URL, here</div>
        </div>
    </div>
</div>
<a  href="https://www.audacityteam.org">
    <div id="logoback" >
        <img id='logo' src="images/audacity-logo.png">
    </div>
</a>
<div style="height:1.9em;"></div>

<div id="content_here" style="text-align:center;">
</div>

<div id="atitle" style="text-align:center;">
    <em>No Hotspot Zones Loaded (Yet)</em>
</div>

<div style="margin-left:10px">
    <div id="message"></div>
<div id="message2"></div>
</div>
<div style="margin-left:50px">
<p>Test of the ImageMap annotation component of the Audacity Toolbox.
<ul>
    <li>Lighter focus spot follows the cursor around</li>
    <li>Darker detail panel moves out the way of the cursor.
    </li></ul>
<p> Click on the 'Show' buttons to see some other examples.
</div>
<div style="margin-left:10px">
    <button onclick=loadDiagram('The_AU19_Crowd')>Show</button> The Audacity 2019 Unconference - an annotated image - <a href="https://wiki.audacityteam.org/wiki/Toolbox/The_AU19_Crowd">from wiki</a><br>
    <button onclick=loadDiagram('LocalThe_Situation_Room')>Show</button> The Situation Room - more annotation of an image.  This is a featured images from Wikipedia<br>
    <button onclick=loadDiagram('Window_Size')>Show</button> Spectrogram
    Window-Size Explanation - an interactive diagram about a spectrogram - <a href="https://wiki.audacityteam.org/wiki/Toolbox/Window_Size">from wiki</a><br><br>

    <button onclick=loadDiagram('Hotspots')>Show</button> More about the Focus-Detail tool - <a href="https://wiki.audacityteam.org/wiki/Toolbox/Hotspots">from wiki</a><br>


<!---
    <button onclick=loadDiagram('The_Ear')>Load</button> Ear Explanation<br>
-->
</div>
<div id="spec" style="margin-left:10px"></div>
</body>
</html>